#include "motor.h"






/* 步进电机(128-8)微步细分速度数据表 */
//------------------------------------------
// double C0 = 69-------
// double C0UP = 9.98-------
// StepMAX = 514-------
// K0 = 1-------
// B0 = 3-------
// K1 = 1-------
// B1 = 0-------
// K2 = 3-------
// double τ = 41.08-------
// 时钟频率 = 16-------
// 分频值 = 8-------
// 细分数 = 65-------
//------------------------------------------
// 步进电机速度 =  7.50--194.24 r/min-------------------------------------------

const uint16_t SpeedCurveTimerVal[390+32]= //速度指数曲线定时值
{
    59530,62267,63140,63588,63866,64058,64201,64311,64399,64472,64533,64586,64631,64671,64706,64738,64766,64792,64815,
    64836,64856,64874,64891,64907,64922,64935,64948,64960,64972,64983,64993,65003,65012,65021,65029,65037,65045,65052,65059,
    65066,65072,65078,65084,65090,65096,65101,65106,65111,65116,65121,65125,65130,65134,65138,65142,65146,65150,65153,65157,
    65160,65164,65167,65170,65173,65177,65180,65182,65185,65188,65191,65193,65196,65199,65201,65204,65206,65208,65211,65213,
    65215,65217,65219,65221,65223,65225,65227,65229,65231,65233,65235,65237,65238,65240,65242,65243,65245,65247,65248,65250,
    65251,65253,65254,65256,65257,65259,65260,65262,65263,65264,65266,65267,65268,65269,65271,65272,65273,65274,65276,65277,
    65278,65279,65280,65281,65282,65283,65284,65286,65287,65288,65289,65290,65291,65292,65293,65294,65294,65295,65296,65297,
    65298,65299,65300,65301,65302,65303,65303,65304,65305,65306,65307,65308,65308,65309,65310,65311,65311,65312,65313,65314,
    65314,65315,65316,65317,65317,65318,65319,65319,65320,65321,65321,65322,65323,65323,65324,65325,65325,65326,65327,65327,
    65328,65328,65329,65330,65330,65331,65331,65332,65332,65333,65334,65334,65335,65335,65336,65336,65337,65337,65338,65338,
    65339,65339,65340,65340,65341,65341,65342,65342,65343,65343,65344,65344,65345,65345,65346,65346,65347,65347,65348,65348,
    65349,65349,65349,65350,65350,65351,65351,65352,65352,65352,65353,65353,65354,65354,65355,65355,65355,65356,65356,65356,
    65357,65357,65358,65358,65358,65359,65359,65360,65360,65360,65361,65361,65361,65362,65362,65362,65363,65363,65364,65364,
    65364,65365,65365,65365,65366,65366,65366,65367,65367,65367,65368,65368,65368,65369,65369,65369,65369,65370,65370,65370,
    65371,65371,65371,65372,65372,65372,65373,65373,65373,65373,65374,65374,65374,65375,65375,65375,65375,65376,65376,65376,
    65377,65377,65377,65377,65378,65378,65378,65378,65379,65379,65379,65379,65380,65380,65380,65381,65381,65381,65381,65382,
    65382,65382,65382,65383,65383,65383,65383,65384,65384,65384,65384,65384,65385,65385,65385,65385,65386,65386,65386,65386,
    65387,65387,65387,65387,65387,65388,65388,65388,65388,65389,65389,65389,65389,65389,65390,65390,65390,65390,65390,65391,
    65391,65391,65391,65392,65392,65392,65392,65392,65393,65393,65393,65393,65393,65394,65394,65394,65394,65394,65395,65395,
    65395,65395,65395,65395,65396,65396,65396,65396,65396,65397,65397,

};

//////////////////////////////////////////////////////////////////////////////////////////////////
const uint16_t SinDataA[1024+1] =   //128*4 //sin波形数据A
{
	0,9,18,28,37,46,55,64,74,83,92,101,110,120,129,138,
	147,156,165,174,184,193,202,211,220,229,238,247,256,266,275,284,
	293,302,311,320,329,338,347,356,364,373,382,391,400,409,418,427,
	435,444,453,462,471,479,488,497,505,514,523,531,540,548,557,566,
	574,583,591,599,608,616,625,633,641,650,658,666,674,683,691,699,
	707,715,723,731,739,747,755,763,771,779,787,795,803,810,818,826,
	833,841,849,856,864,871,879,886,894,901,908,916,923,930,937,944,
	952,959,966,973,980,987,994,1001,1007,1014,1021,1028,1034,1041,1048,1054,
	1061,1067,1074,1080,1086,1093,1099,1105,1111,1118,1124,1130,1136,1142,1148,1154,
	1160,1165,1171,1177,1183,1188,1194,1199,1205,1210,1216,1221,1226,1232,1237,1242,
	1247,1252,1257,1262,1267,1272,1277,1282,1287,1291,1296,1301,1305,1310,1314,1319,
	1323,1327,1331,1336,1340,1344,1348,1352,1356,1360,1364,1368,1371,1375,1379,1382,
	1386,1389,1393,1396,1399,1403,1406,1409,1412,1415,1418,1421,1424,1427,1430,1433,
	1435,1438,1441,1443,1446,1448,1450,1453,1455,1457,1459,1462,1464,1466,1467,1469,
	1471,1473,1475,1476,1478,1479,1481,1482,1484,1485,1486,1488,1489,1490,1491,1492,
	1493,1494,1494,1495,1496,1497,1497,1498,1498,1499,1499,1499,1500,1500,1500,1500,
	1500,1500,1500,1500,1500,1499,1499,1499,1498,1498,1497,1497,1496,1495,1494,1494,
	1493,1492,1491,1490,1489,1488,1486,1485,1484,1482,1481,1479,1478,1476,1475,1473,
	1471,1469,1467,1466,1464,1462,1459,1457,1455,1453,1450,1448,1446,1443,1441,1438,
	1435,1433,1430,1427,1424,1421,1418,1415,1412,1409,1406,1403,1399,1396,1393,1389,
	1386,1382,1379,1375,1371,1368,1364,1360,1356,1352,1348,1344,1340,1336,1331,1327,
	1323,1319,1314,1310,1305,1301,1296,1291,1287,1282,1277,1272,1267,1262,1257,1252,
	1247,1242,1237,1232,1226,1221,1216,1210,1205,1199,1194,1188,1183,1177,1171,1165,
	1160,1154,1148,1142,1136,1130,1124,1118,1111,1105,1099,1093,1086,1080,1074,1067,
	1061,1054,1048,1041,1034,1028,1021,1014,1007,1001,994,987,980,973,966,959,
	952,944,937,930,923,916,908,901,894,886,879,871,864,856,849,841,
	833,826,818,810,803,795,787,779,771,763,755,747,739,731,723,715,
	707,699,691,683,674,666,658,650,641,633,625,616,608,599,591,583,
	574,566,557,548,540,531,523,514,505,497,488,479,471,462,453,444,
	435,427,418,409,400,391,382,373,364,356,347,338,329,320,311,302,
	293,284,275,266,256,247,238,229,220,211,202,193,184,174,165,156,
	147,138,129,120,110,101,92,83,74,64,55,46,37,28,18,9,0, 
	//以上是一个正半周
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*01*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*02*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*03*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*04*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*05*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*06*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*07*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*08*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*09*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*10*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*11*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*12*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*13*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*14*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*15*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*16*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*17*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*18*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*19*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*20*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*21*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*22*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*23*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*24*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*25*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*26*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*27*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*28*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*29*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*30*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*31*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*32*/
};
const uint16_t SinDataB[1024+1] =   //128*4 //sin波形数据B
{
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*01*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*02*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*03*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*04*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*05*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*06*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*07*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*08*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*09*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*10*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*11*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*12*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*13*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*14*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*15*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*16*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*17*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*18*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*19*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*20*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*21*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*22*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*23*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*24*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*25*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*26*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*27*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*28*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*29*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*30*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*31*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*32*/
	//以下是一个负半周
	0,9,18,28,37,46,55,64,74,83,92,101,110,120,129,138,
	147,156,165,174,184,193,202,211,220,229,238,247,256,266,275,284,
	293,302,311,320,329,338,347,356,364,373,382,391,400,409,418,427,
	435,444,453,462,471,479,488,497,505,514,523,531,540,548,557,566,
	574,583,591,599,608,616,625,633,641,650,658,666,674,683,691,699,
	707,715,723,731,739,747,755,763,771,779,787,795,803,810,818,826,
	833,841,849,856,864,871,879,886,894,901,908,916,923,930,937,944,
	952,959,966,973,980,987,994,1001,1007,1014,1021,1028,1034,1041,1048,1054,
	1061,1067,1074,1080,1086,1093,1099,1105,1111,1118,1124,1130,1136,1142,1148,1154,
	1160,1165,1171,1177,1183,1188,1194,1199,1205,1210,1216,1221,1226,1232,1237,1242,
	1247,1252,1257,1262,1267,1272,1277,1282,1287,1291,1296,1301,1305,1310,1314,1319,
	1323,1327,1331,1336,1340,1344,1348,1352,1356,1360,1364,1368,1371,1375,1379,1382,
	1386,1389,1393,1396,1399,1403,1406,1409,1412,1415,1418,1421,1424,1427,1430,1433,
	1435,1438,1441,1443,1446,1448,1450,1453,1455,1457,1459,1462,1464,1466,1467,1469,
	1471,1473,1475,1476,1478,1479,1481,1482,1484,1485,1486,1488,1489,1490,1491,1492,
	1493,1494,1494,1495,1496,1497,1497,1498,1498,1499,1499,1499,1500,1500,1500,1500,
	1500,1500,1500,1500,1500,1499,1499,1499,1498,1498,1497,1497,1496,1495,1494,1494,
	1493,1492,1491,1490,1489,1488,1486,1485,1484,1482,1481,1479,1478,1476,1475,1473,
	1471,1469,1467,1466,1464,1462,1459,1457,1455,1453,1450,1448,1446,1443,1441,1438,
	1435,1433,1430,1427,1424,1421,1418,1415,1412,1409,1406,1403,1399,1396,1393,1389,
	1386,1382,1379,1375,1371,1368,1364,1360,1356,1352,1348,1344,1340,1336,1331,1327,
	1323,1319,1314,1310,1305,1301,1296,1291,1287,1282,1277,1272,1267,1262,1257,1252,
	1247,1242,1237,1232,1226,1221,1216,1210,1205,1199,1194,1188,1183,1177,1171,1165,
	1160,1154,1148,1142,1136,1130,1124,1118,1111,1105,1099,1093,1086,1080,1074,1067,
	1061,1054,1048,1041,1034,1028,1021,1014,1007,1001,994,987,980,973,966,959,
	952,944,937,930,923,916,908,901,894,886,879,871,864,856,849,841,
	833,826,818,810,803,795,787,779,771,763,755,747,739,731,723,715,
	707,699,691,683,674,666,658,650,641,633,625,616,608,599,591,583,
	574,566,557,548,540,531,523,514,505,497,488,479,471,462,453,444,
	435,427,418,409,400,391,382,373,364,356,347,338,329,320,311,302,
	293,284,275,266,256,247,238,229,220,211,202,193,184,174,165,156,
	147,138,129,120,110,101,92,83,74,64,55,46,37,28,18,9,0, 
};
const uint16_t CosDataC[1024+1] =   //128*4 //Cos波形数据C
{
	1500,1500,1500,1500,1500,1499,1499,1499,1498,1498,1497,1497,1496,1495,1494,1494,
	1493,1492,1491,1490,1489,1488,1486,1485,1484,1482,1481,1479,1478,1476,1475,1473,
	1471,1469,1467,1466,1464,1462,1459,1457,1455,1453,1450,1448,1446,1443,1441,1438,
	1435,1433,1430,1427,1424,1421,1418,1415,1412,1409,1406,1403,1399,1396,1393,1389,
	1386,1382,1379,1375,1371,1368,1364,1360,1356,1352,1348,1344,1340,1336,1331,1327,
	1323,1319,1314,1310,1305,1301,1296,1291,1287,1282,1277,1272,1267,1262,1257,1252,
	1247,1242,1237,1232,1226,1221,1216,1210,1205,1199,1194,1188,1183,1177,1171,1165,
	1160,1154,1148,1142,1136,1130,1124,1118,1111,1105,1099,1093,1086,1080,1074,1067,
	1061,1054,1048,1041,1034,1028,1021,1014,1007,1001,994,987,980,973,966,959,
	952,944,937,930,923,916,908,901,894,886,879,871,864,856,849,841,
	833,826,818,810,803,795,787,779,771,763,755,747,739,731,723,715,
	707,699,691,683,674,666,658,650,641,633,625,616,608,599,591,583,
	574,566,557,548,540,531,523,514,505,497,488,479,471,462,453,444,
	435,427,418,409,400,391,382,373,364,356,347,338,329,320,311,302,
	293,284,275,266,256,247,238,229,220,211,202,193,184,174,165,156,
	147,138,129,120,110,101,92,83,74,64,55,46,37,28,18,9,0,
	//以上是小半周
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*01*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*02*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*03*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*04*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*05*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*06*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*07*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*08*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*09*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*10*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*11*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*12*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*13*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*14*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*15*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*16*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*17*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*18*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*19*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*20*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*21*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*22*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*23*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*24*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*25*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*26*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*27*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*28*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*29*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*30*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*31*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*32*/
	//以下是小半周
	9,18,28,37,46,55,64,74,83,92,101,110,120,129,138,147,
	156,165,174,184,193,202,211,220,229,238,247,256,266,275,284,293,
	302,311,320,329,338,347,356,364,373,382,391,400,409,418,427,435,
	444,453,462,471,479,488,497,505,514,523,531,540,548,557,566,574,
	583,591,599,608,616,625,633,641,650,658,666,674,683,691,699,707,
	715,723,731,739,747,755,763,771,779,787,795,803,810,818,826,833,
	841,849,856,864,871,879,886,894,901,908,916,923,930,937,944,952,
	959,966,973,980,987,994,1001,1007,1014,1021,1028,1034,1041,1048,1054,1061,
	1067,1074,1080,1086,1093,1099,1105,1111,1118,1124,1130,1136,1142,1148,1154,1160,
	1165,1171,1177,1183,1188,1194,1199,1205,1210,1216,1221,1226,1232,1237,1242,1247,
	1252,1257,1262,1267,1272,1277,1282,1287,1291,1296,1301,1305,1310,1314,1319,1323,
	1327,1331,1336,1340,1344,1348,1352,1356,1360,1364,1368,1371,1375,1379,1382,1386,
	1389,1393,1396,1399,1403,1406,1409,1412,1415,1418,1421,1424,1427,1430,1433,1435,
	1438,1441,1443,1446,1448,1450,1453,1455,1457,1459,1462,1464,1466,1467,1469,1471,
	1473,1475,1476,1478,1479,1481,1482,1484,1485,1486,1488,1489,1490,1491,1492,1493,
	1494,1494,1495,1496,1497,1497,1498,1498,1499,1499,1499,1500,1500,1500,1500,1500,
};
const uint16_t CosDataD[1024+1] =   //128*4 //Cos波形数据D
{
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*01*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*02*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*03*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*04*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*05*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*06*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*07*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*08*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*09*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*10*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*11*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*12*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*13*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*14*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*15*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*16*/ 
	//以下是负半周
	0,9,18,28,37,46,55,64,74,83,92,101,110,120,129,138,
	147,156,165,174,184,193,202,211,220,229,238,247,256,266,275,284,
	293,302,311,320,329,338,347,356,364,373,382,391,400,409,418,427,
	435,444,453,462,471,479,488,497,505,514,523,531,540,548,557,566,
	574,583,591,599,608,616,625,633,641,650,658,666,674,683,691,699,
	707,715,723,731,739,747,755,763,771,779,787,795,803,810,818,826,
	833,841,849,856,864,871,879,886,894,901,908,916,923,930,937,944,
	952,959,966,973,980,987,994,1001,1007,1014,1021,1028,1034,1041,1048,1054,
	1061,1067,1074,1080,1086,1093,1099,1105,1111,1118,1124,1130,1136,1142,1148,1154,
	1160,1165,1171,1177,1183,1188,1194,1199,1205,1210,1216,1221,1226,1232,1237,1242,
	1247,1252,1257,1262,1267,1272,1277,1282,1287,1291,1296,1301,1305,1310,1314,1319,
	1323,1327,1331,1336,1340,1344,1348,1352,1356,1360,1364,1368,1371,1375,1379,1382,
	1386,1389,1393,1396,1399,1403,1406,1409,1412,1415,1418,1421,1424,1427,1430,1433,
	1435,1438,1441,1443,1446,1448,1450,1453,1455,1457,1459,1462,1464,1466,1467,1469,
	1471,1473,1475,1476,1478,1479,1481,1482,1484,1485,1486,1488,1489,1490,1491,1492,
	1493,1494,1494,1495,1496,1497,1497,1498,1498,1499,1499,1499,1500,1500,1500,1500,
	1500,1500,1500,1500,1500,1499,1499,1499,1498,1498,1497,1497,1496,1495,1494,1494,
	1493,1492,1491,1490,1489,1488,1486,1485,1484,1482,1481,1479,1478,1476,1475,1473,
	1471,1469,1467,1466,1464,1462,1459,1457,1455,1453,1450,1448,1446,1443,1441,1438,
	1435,1433,1430,1427,1424,1421,1418,1415,1412,1409,1406,1403,1399,1396,1393,1389,
	1386,1382,1379,1375,1371,1368,1364,1360,1356,1352,1348,1344,1340,1336,1331,1327,
	1323,1319,1314,1310,1305,1301,1296,1291,1287,1282,1277,1272,1267,1262,1257,1252,
	1247,1242,1237,1232,1226,1221,1216,1210,1205,1199,1194,1188,1183,1177,1171,1165,
	1160,1154,1148,1142,1136,1130,1124,1118,1111,1105,1099,1093,1086,1080,1074,1067,
	1061,1054,1048,1041,1034,1028,1021,1014,1007,1001,994,987,980,973,966,959,
	952,944,937,930,923,916,908,901,894,886,879,871,864,856,849,841,
	833,826,818,810,803,795,787,779,771,763,755,747,739,731,723,715,
	707,699,691,683,674,666,658,650,641,633,625,616,608,599,591,583,
	574,566,557,548,540,531,523,514,505,497,488,479,471,462,453,444,
	435,427,418,409,400,391,382,373,364,356,347,338,329,320,311,302,
	293,284,275,266,256,247,238,229,220,211,202,193,184,174,165,156,
	147,138,129,120,110,101,92,83,74,64,55,46,37,28,18,9,
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*01*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*02*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*03*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*04*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*05*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*06*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*07*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*08*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*09*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*10*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*11*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*12*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*13*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*14*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*15*/
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, /*16*/
};













static uint8_t  Motor1_dir                      = 1;						 //步进电机方向1正向，0反向
static uint8_t  LineFlag                        = YES;
static uint8_t  Motor1WillBackFlag              = 0; 						 //请求步进电机后退 标志
static uint8_t  Motor1_Stop_Flag                = 0; 						 //步进电机停止标志
static uint8_t  Motor1_speed_postion_dir        = 1; 						 //步进电机速度定位方向
static uint8_t  Motor1_dir_Current              = 1;             //步进电机当前方向
static int16_t MotorPositionPointer             = 0;             //步进电机位置指针
static uint16_t step_startstop                  = 0;  			 //起停距离1-256微步 起停距离2-512微步
static int32_t Motor1_postion_Current           = StartPostion;  //步进电机当前位置
static int32_t Motor1_postion_user              = StartPostion;  //步进电机用户设置位置
static int32_t Motor1_user_postion_gap          = 0; //用户定位间隔
static int32_t Motor1_dynamic_postion_gap       = 0; //动态定位间隔

uint8_t DecayXCurrentFlag  						= 0; 			 //当前电流衰减标志
uint16_t MotorXSpeedPos                         = 0;             //步进电机加速位置
uint16_t MotorXStep_StartStop                   = MAXMOTORSPEED; //最高转速速度 MotorSpeed
int32_t CounterMotorXStepPostionCurrent         = StartPostion;  //步进电机1当前位置计数器


/******************************************************************************
*函数名称:static uint8_t CheckValChange1(int32_t Val)
*功能说明:检测值变化
*输入参数:Val = 输入值
*输出参数:m=YES/NO
*******************************************************************************/
static uint8_t CheckValChange1(int32_t Val)
{
    static int32_t tempa1    = 0;
    static int32_t tempb1    = 0;
    static uint8_t  i         = 0;
    static uint8_t  m         = 0;
//-----------------------------------
    i++;
    switch (i)
    {
    case 1:
        tempa1 = Val; //第一存储
        break;
    case 2:
        i = 0;      //CLR 0
        tempb1 = Val; //第二次存储
        break;
    }
    //-------------------------------
    if (tempa1 != tempb1) //两次值不等，表示值有变化
    {
        m = YES;//返回有变化
    }
    else                  //两次值相等，表示值有变化
    {
        m = NO;  //返回没有变化
    }
    return m;
//-------------------------------------------------------------------
}
/******************************************************************************
*函数名称:static void Motor1_postion_control(int32_t postion)
*功能说明:电机1位置控制设置
*输入参数:postion=要设置的位置0-255
*输出参数:无
*******************************************************************************/
static void Motor1_postion_control(int32_t postion)   // 一个位置 ==  ？
{
    if (CheckValChange1(postion)) //判断值是否有变化
    {
        //-------------------------------------------------------------------------------------------------
        Motor1_postion_user = postion;            //用户设定位置  全局变量
        Motor1WaitProgram();                      //电机等待设置位置
    }//-----------------------------------------------------------------------------------------------------
}

/******************************************************************************
*函数名称:static void Motor1_postion_control(int32_t postion)
*功能说明:电机1DMX数据控制位置设置
*输入参数:Dmxdata=DMX控制位置的数据(粗调),Finedata=精确的数据(微调)
*输出参数:无
*******************************************************************************/
void MotorXDmxDataControl(uint8_t Dmxdata,uint8_t Finedata)
{
    //0-255 ==== 0-9R*200 =1800  1800/255 = 7.05     540/360=1.5 *变比==> 1.5*6=9
    static int32_t i=0;
    static uint8_t RatioA  = 1;		//50;   //8  9 比例A
    static uint8_t RatioB  = 1;		//255;  //1    比例B
    i = (int32_t)((Dmxdata*MaxStep*RatioA/RatioB)+Finedata/45);//255*16*7+0=28560
    Motor1_postion_control(i); //电机1位置控制设置
}

/******************************************************************************
*函数名称:void ResetMotorFunction(void)
*功能说明:重新设置电机位置
*输入参数:无
*输出参数:无
*******************************************************************************/
void ResetMotorFunction(void) //重新设置电机位置
{
    //-------------------------------------------------------------------------
    MotorXStep_StartStop = MAXMOTORSPEED;  //最高速度
    Motor1_postion_user  = 0;
    //-------------------------------------------------------------------------
}

/******************************************************************************
*函数名称:static uint8_t CheckValChange2(int32_t Val)
*功能说明:检测值变化
*输入参数:Val = 输入值
*输出参数:m=YES/NO
*******************************************************************************/
static uint8_t CheckValChange2(int32_t Val)
{
    static int32_t tempa1    = 0;
    static int32_t tempb1    = 0;
    static uint8_t  i         = 0;
    static uint8_t  m         = 0;
//-----------------------------------
    i++;
    switch (i)
    {
    case 1:
        tempa1 = Val;
        break;
    case 2:
        i = 0;      //CLR 0
        tempb1 = Val;
        break;
    }
    //-------------------------------
    if (tempa1 != tempb1)
    {
        m = YES;
    }
    else
    {
        m = NO;
    }
    return m;
//-------------------------------------------------------------------
}

/******************************************************************************
*函数名称:static void Motor1WaitProgram(void)
*功能说明:电机1设置位置
*输入参数:无
*输出参数:无
*******************************************************************************/
static void Motor1WaitProgram(void)
{
    if (Motor1_postion_user  > Motor1_postion_Current) //如果步进电机设置位置 > 当前位置
    {
        Motor1_user_postion_gap   = Motor1_postion_user - Motor1_postion_Current; //得到位置差值间隔
        if (Motor1_dir_Current == 1)  //步进电机当前电流方向 正向
        {
            Motor1WillBackFlag = 0;   //不后退
        }
        else
        {
            Motor1WillBackFlag = 1;   //后退
        }
				//---------------------------------------
        if (Motor1_Stop_Flag) //判断电机是否停止
        {
            Motor1_speed_postion_dir = YES; //步进电机位置加速方向为1
        }
    }
//--------------------------------------------------------------------------------------------------------------------------
    if (Motor1_postion_user  < Motor1_postion_Current) //如果步进电机设置位置 < 当前位置
    {
        Motor1_user_postion_gap   = Motor1_postion_Current  - Motor1_postion_user; //得到位置差值间隔
        if (Motor1_dir_Current == 0) //电流方向 反向
        {
            Motor1WillBackFlag = 0;  //不后退
        }
        else
        {
            Motor1WillBackFlag = 1;  //后退
        }
				//---------------------------------------
        if (Motor1_Stop_Flag) //判断电机是否停止
        {
            Motor1_speed_postion_dir = NO; //步进电机位置加速方向为0
        }
    }
//----------------------------------------------------------------------------------------------!!!!!!!!########此处不懂!!!!!!!!########---------------
    if (Motor1_user_postion_gap <= 8*MaxStep) //如果位置差值间隔 <= 8倍的最大步数
    {
        step_startstop = Motor1_user_postion_gap/MaxStep / 4; //启停步数
    }
    else if ((8*MaxStep < Motor1_user_postion_gap) && (Motor1_user_postion_gap < MotorXStep_StartStop*2*MaxStep)) //<=512*2
					{
							// only two state 只有两个状态
							step_startstop = Motor1_user_postion_gap/MaxStep / 2; //步进电机的启停步数
					}
					else //否则就给最高转速
					{
							step_startstop = MotorXStep_StartStop; //启停步数得到最高转速
					}
		
    if (Motor1_user_postion_gap <= 80*MaxStep) //如果位置差值间隔 <= 80倍的最大步数
    {
        DecayXCurrentFlag = 1; //电流衰减标志置1
    }
    else
    {
        DecayXCurrentFlag = 0; //电流衰减标志置0
    }
}





/******************************************************************************
*函数名称:static void Motor1PointerControl(void)
*功能说明:电机1位置控制
*输入参数:无
*输出参数:无
*******************************************************************************/
static void Motor1PointerControl(void)        //100us*32 == 3.2ms     LOOP in Time0
{
    static uint16_t iStop = 0; //停止
    //----------------------------------------------------------------------DmxFinedataUser
    if ((Motor1_postion_Current == Motor1_postion_user)&&(!MotorXSpeedPos)) //如果当前位置等于设置位置及加速位置为0
    {   //如果当前位置等于用户位置，步进电机就停止
        Motor1_user_postion_gap    = 0; //用户定位间隔为0
        Motor1_dynamic_postion_gap = 0; //动态定位间隔为0
        LineFlag = 2;	//1 加速  0 减速  2 匀速 (停止)
        //-----------静止时也要输出波形使步进电机位置不变----------------------------
        if (iStop > 30) //655us/2*500   静止时电流为正常的1/4
        {//数据除于2使输出电流减小
//					  Current_Attenuation(2); //步进电机电流衰减等级选择
//						DECAY  = 0;  //步进电机整体电流衰减控制脚
            TIM3->CCR2  =  SinDataA[MotorPositionPointer]>>0;  //Sin波形数据A
            TIM3->CCR1  =  SinDataB[MotorPositionPointer]>>0;  //Sin波形数据B
            TIM3->CCR4  =  CosDataC[MotorPositionPointer]>>0;  //Sin波形数据C
            TIM3->CCR3  =  CosDataD[MotorPositionPointer]>>0;  //Sin波形数据D
        }
        else
        {
            iStop++;	//停止后电流衰减计数
//						Current_Attenuation(1); //步进电机电流衰减等级选择
//						DECAY  = 0;  //步进电机整体电流衰减控制脚
//						TIM3->CCR1  =  SinDataA[MotorPositionPointer]>>0;  //Sin波形数据A
//            TIM3->CCR2  =  SinDataB[MotorPositionPointer]>>0;  //Sin波形数据B
//            TIM3->CCR3  =  CosDataC[MotorPositionPointer]>>0;  //Sin波形数据C
//            TIM3->CCR4  =  CosDataD[MotorPositionPointer]>>0;  //Sin波形数据D
        }	
    }
    else  
    {
        iStop = 0; //停止计数清零
        if (DecayXCurrentFlag) //如果当前电流衰减标志=1
        {   //就把数据除2
//					  Current_Attenuation(2); //步进电机电流衰减等级选择
//					  DECAY  = 0;  //步进电机整体电流衰减控制脚
            TIM3->CCR2  =  SinDataA[MotorPositionPointer]>>0;  //Sin波形数据A
            TIM3->CCR1  =  SinDataB[MotorPositionPointer]>>0;  //Sin波形数据B
            TIM3->CCR4  =  CosDataC[MotorPositionPointer]>>0;  //Sin波形数据C
            TIM3->CCR3  =  CosDataD[MotorPositionPointer]>>0;  //Sin波形数据D
        }
        else
        {   //否则就给平滑数据
//					  Current_Attenuation(1); //步进电机电流衰减等级选择
//					  DECAY  = 1;  //步进电机整体电流衰减控制脚
            TIM3->CCR2  =  SinDataA[MotorPositionPointer]>>0;  //Sin波形数据A
            TIM3->CCR1  =  SinDataB[MotorPositionPointer]>>0;  //Sin波形数据B
            TIM3->CCR4  =  CosDataC[MotorPositionPointer]>>0;  //Sin波形数据C
            TIM3->CCR3  =  CosDataD[MotorPositionPointer]>>0;  //Sin波形数据D
        }
        //---------正反转控制-----------------------------------------
        if (Motor1_dir == 1)            //用户欲控制方向 为正向时
        {
            Motor1_dir_Current     = 1; //电机当前方向置1正向
        }
        else                           //用户欲控制方向 为反向时
        {
            Motor1_dir_Current     = 0; //电机当前方向置0反向
        }
        //------------------------------------------------------------
        if (Motor1_dir_Current == YES)   //控制步进电机 正向转动
        {
            //不加则停止转动 锁定状态
            MotorPositionPointer += MaxStep;	//16*2;  					//步进电机位置指针加16
            CounterMotorXStepPostionCurrent += 1;   //步进电机定位步数加1
            //-------------走完一个正弦曲线是1024个数据------------------------
            if (MotorPositionPointer >= 1024) 			//位置指针大于1024就清零
            {
                MotorPositionPointer = 0;					  //清零，重新走正弦曲线
            }
        }
        else //否则控制步进电机 反向转动
        {
            MotorPositionPointer -= MaxStep;	//16*2;           //步进电机位置指针减16
            CounterMotorXStepPostionCurrent -= 1;   //步进电机定位步数减1
            //--------------------------------------------------
            if (MotorPositionPointer <= 0)     //位置指针小于等于0就给最大1024 
            { 
                MotorPositionPointer = 1024;   //指针从正弦曲线的最大开始取
            }
        }
    }
//---------------------------------------------------------------------------------------------------------------
    Motor1_postion_Current = CounterMotorXStepPostionCurrent; //把计数的步给当前位置寄存器
    //当前状态侦测  并存入状态寄存器 存入当前状态
//---------------------------------------------------------------------------------------------------------------
}


/******************************************************************************
*函数名称:static void Motor1DynamicPostionGap(void) 
*功能说明:电机1动态定位间隔
*输入参数:无
*输出参数:无
*******************************************************************************/
static void Motor1DynamicPostionGap(void)             // LOOP IN TIME0 48us
{
		//------------------------------------------------------------------------
    if (!MotorXSpeedPos) 			//如果步进电机位置加速为零
    {
        Motor1_Stop_Flag = 1; //步进电机停止标志置1
    }
    else
    {
        Motor1_Stop_Flag = 0; //步进电机停止标志置0
    }
    //-------------------------------------------------------------------
    if (Motor1_Stop_Flag)  //如果步进电机停止标志置1
    {
        Motor1WaitProgram(); //查看是否更新的位置设置值
    }
		//-------------------------------------------------------------------------------------
    if (Motor1_postion_user == Motor1_postion_Current) //如果用户设置位置=当前位置
    {
        Motor1_dynamic_postion_gap = 0; //动态定位间隔清零
    }
    else
			if (Motor1_postion_user  > Motor1_postion_Current) //如果用户位置 > 当前位置
			{
					// 同向
					Motor1_dynamic_postion_gap  = Motor1_postion_user - Motor1_postion_Current;   //位置差 Postion_gap   一个位置差为10步 一圈200步
					if (Motor1_Stop_Flag) //如果有停止标志
					{
							Motor1_speed_postion_dir = YES; //步进电机速度定位方向为1
					}
			}
			else 
			if (Motor1_postion_user < Motor1_postion_Current) //如果用户位置 < 当前位置
			{
					Motor1_dynamic_postion_gap  = Motor1_postion_Current - Motor1_postion_user;    //反向位置差值
					if (Motor1_Stop_Flag) //如果有停止标志
					{
							Motor1_speed_postion_dir = NO; //步进电机速度定位方向为0
					}
			}
//---------------------------------------------------------------------------------------
}

/******************************************************************************
*函数名称:static uint8_t CheckValChange3(int32_t Val)
*功能说明:检测值变化
*输入参数:Val = 输入值
*输出参数:m=YES/NO
*******************************************************************************/
static uint8_t CheckValChange3(int32_t Val)
{
    static int32_t tempa1    = 0;
    static int32_t tempb1    = 0;
    static uint8_t  i         = 0;
    static uint8_t  m         = 0;
//----------------------------------
    i++;
    switch (i)
    {
    case 1:
        tempa1 = Val;
        break;
    case 2:
        i = 0;      //CLR 0
        tempb1 = Val;
        break;
    }
    //-------------------------------
    if (tempa1 != tempb1)
    {
        m = YES;
    }
    else
    {
        m = NO;
    }
    return m;
//-------------------------------------------------------------------
}

/******************************************************************************
*函数名称:static void Motor1_drive(uint8_t dir,uint16_t SpeedPostion) 
*功能说明:电机1驱动函数，
*输入参数:dir=?,SpeedPostion=?
*输出参数:无
*******************************************************************************/
static void Motor1_drive(uint8_t dir,uint16_t SpeedPostion)    //STEP  步进电机步数  200步 为一圈
{
    static uint16_t SpeedVal =0;
    SpeedVal = SpeedCurveTimerVal[SpeedPostion]; //设置电机的速度,速度S曲线定时值
    //----------------------------------------------------------------------
    Motor1_dir    = dir;                         //得到方向
    TIM1CCR3_Val  = 65535 - SpeedVal;  //uint16_t //更新定时器1的定时值
}

/******************************************************************************
*函数名称:static void Motor1PostionControlSpeed(void) 
*功能说明:电机1位置速度控制
*输入参数:无
*输出参数:无
*******************************************************************************/
static void Motor1PostionControlSpeed(void)          // LOOP IN T0
{
//---------------------------------------------------------------------------------------
    if (CheckValChange3(Motor1_dynamic_postion_gap)) //如果数据有变化
    {
        if (((Motor1_user_postion_gap-step_startstop*MaxStep) < Motor1_dynamic_postion_gap) && (Motor1_dynamic_postion_gap <= Motor1_user_postion_gap))
        {
            LineFlag = 1;    //1 加速  0 减速  2 匀速 (停止)
        }
    }
    Motor1_drive(Motor1_speed_postion_dir,MotorXSpeedPos); //电机1S曲线驱动函数

    if (CheckValChange2(Motor1_dynamic_postion_gap/MaxStep)) //检查值是否有变化
    {
        if (Motor1WillBackFlag==0)//如果步进电机电流不衰减
        {
            //-----------------------------------------------------------------
            if ((0 < Motor1_dynamic_postion_gap) && (Motor1_dynamic_postion_gap <= MotorXSpeedPos*MaxStep))  //loop 20*256/x (256-32) 20为20步
            {
                if (MotorXSpeedPos) //如果加速位置不为0
                {
										MotorXSpeedPos--;  //减速制动
                    LineFlag = 0;      //直线标志为0 减速
                }
            }//-----------------------------------------------------------------
            else 
						if ((step_startstop*MaxStep < Motor1_dynamic_postion_gap) && (Motor1_dynamic_postion_gap <= (Motor1_user_postion_gap-step_startstop*MaxStep)))
            {
                LineFlag = 2;          //直线标志为2 匀速停止 
            }//-----------------------------------------------------------------
            else 
						if (((Motor1_user_postion_gap-step_startstop*MaxStep) < Motor1_dynamic_postion_gap) && (Motor1_dynamic_postion_gap <= Motor1_user_postion_gap))
            {
                if (MotorXSpeedPos<step_startstop)
                {
                    MotorXSpeedPos++;  //加速启动							
                    LineFlag = 1;      //直线标志为1 加速
                }
            }//-----------------------------------------------------------------
            else
						if (Motor1_dynamic_postion_gap > Motor1_user_postion_gap)
            {
                Motor1WillBackFlag = 1;  //减速制动
            }
        }
        //-----------------------------------------------------------------------
        else 
				if (Motor1WillBackFlag == 1) //如果步进电机衰减标志置1
        {
            if (MotorXSpeedPos) 	//加速位置不为0
            {
                MotorXSpeedPos--; //加速位置减1 						 
                LineFlag = 0;   	//直线标志清零 
            }
            else
            {
                Motor1WillBackFlag = 0; //减速制动 清零
            }
        }
    }
//-------------------------------------------------------------------------------
}














/******************************************************************************
*函数名称:void MotorXDriveInTimer(void)
*功能说明:电机X驱动定时函数
*输入参数:无
*输出参数:无
*******************************************************************************/
void MotorXDriveInTimer(void)
{
    Motor1PointerControl();      //电机1位置控制
    Motor1DynamicPostionGap();   //电机1动态定位间隔
    Motor1PostionControlSpeed(); //电机1位置速度控制
}

